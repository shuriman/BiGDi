# Архитектурный обзор

Документ суммирует ключевые решения и связи между сервисами в целевой архитектуре Zemo.

## Ключевые принципы
- **API-first**: любой функционал доступен через документированный REST API. UI (SSR/SPA) работает поверх этих контрактов.
- **Модульность**: отдельные сервисы `api` и `worker` с чёткими bounded contexts (Identity, Settings, Jobs, Prompts, Analytics и т.д.).
- **Наблюдаемость по умолчанию**: структурные логи, метрики и трассы включаются с первого дня.
- **Безопасность**: строгая валидация входа, RBAC, шифрование секретов, аудит действий.

## Сервисы и их обязанности
| Сервис | Ответственность | Технологии |
|--------|-----------------|------------|
| api | REST API, SSR, WebSocket/SSE, авторизация, постановка задач | NestJS, Prisma, Pino |
| worker | BullMQ воркеры, Puppeteer, SerpApi/LLM, текстовый анализ | Node.js, BullMQ, Prisma |
| postgres | Хранилище данных, миграции, pgcrypto/pgvector | PostgreSQL 16 |
| redis | Очереди и кеш, pub/sub для realtime | Redis 7 |
| phpmorphy | Морфологический анализ | PHP сервис (существующий) |
| otel-collector | Приём телеметрии (OTLP) | OpenTelemetry Collector |
| prometheus | Сбор метрик | Prometheus + Grafana (внешне) |

## Границы модулей (внутри сервисов)
- **Identity & Access** — авторизация, токены, управление пользователями (при необходимости).
- **Settings & Secrets** — хранение ключей провайдеров, валидация, аудит.
- **Jobs** — постановка, статусы, прогресс, логи, realtime.
- **SerpApi Adapter** — нормализация, кеш, ретраи.
- **Scraper** — политика запуска Puppeteer, пул браузеров.
- **Text Processing** — обращения к phpmorphy, фильтрация контента.
- **Embeddings & Similarity** — расчёт и хранение эмбеддингов (pgvector).
- **LLM Providers** — унифицированный интерфейс, управление лимитами токенов.
- **Prompts** — CRUD, версии, предпросмотр данных.
- **Reports/Analytics** — агрегации, экспорт, dashboards.
- **Audit/Logs** — сбор событий, хранение в Postgres.

## Потоки данных
1. Пользователь создаёт задачу (`POST /api/jobs`). API валидирует payload, шифрует секреты и ставит задачу в Redis.
2. Worker потребляет задачу, выполняет операции (SerpApi/Puppeteer/LLM), пишет промежуточные шаги в `job_logs` и статус в `jobs`.
3. API через SSE/WebSocket стримит обновления UI. Пользователь видит прогресс в реальном времени.
4. Результаты (страницы, заголовки, эмбеддинги, generated_text) сохраняются в PostgreSQL. Тяжёлые данные (сырые SERP) периодически архивируются.
5. Метрики и логи отправляются в Otel Collector → Prometheus / лог-систему.

## Интеграции и безопасность
- Сертификаты и секреты поставляются через Docker secrets/Vault.
- Внешние API вызываются через адаптеры с retry, rate limit и circuit breaker.
- RBAC привязывается к JWT claims; административные действия записываются в `audit_events`.

## Дальнейшие шаги
- Завершить оценку миграции данных (см. `er-diagram.md`, `migration-plan.md`).
- Реализовать прототип API/worker, подключить Prisma и BullMQ.
- Настроить CI/CD (lint/test/build, prisma migrate, docker build).
- Подготовить дашборды и алёрты (см. `nfr.md`).

Этот обзор служит отправной точкой и должен обновляться при изменении архитектуры.
