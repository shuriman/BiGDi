# ADR 0002 — ORM и стратегия миграций

- **Дата**: 2025-11-07
- **Статус**: Утверждено
- **Контекст**: Требуется перемещение с SQLite на PostgreSQL, поддержка сложных типов (JSONB, pgvector), миграции, генерация типов и совместное использование модели в `api` и `worker`.

## Решение
Использовать **Prisma ORM** в режиме `prisma-client-js`, миграции `prisma migrate` и дополнительный слой SQL-скриптов в `infra/migrations` для системных расширений (`pgcrypto`, `pgvector`).

## Обоснование
- Prisma генерирует типизированный клиент и DTO, что упрощает работу с TypeScript.
- Хорошая поддержка PostgreSQL, включая JSONB, enums, связки, middleware.
- Поддерживает declarative миграции, diﬀ, автоматическую документацию схемы.
- Можно вынести общие типы в `packages/shared`, использовать в API и worker.

## Рассмотренные альтернативы
| Вариант | Плюсы | Минусы |
|---------|-------|--------|
| TypeORM | Зрелая экосистема | Больше "магии", сложные миграции, слабее поддержка pgvector. |
| Drizzle ORM | Лёгкий, типобезопасный | Молодой проект, меньше интеграций, нет встроенного клиента генерации для Nest. |
| Knex.js + ручной SQL | Полный контроль | Высокие усилия по поддержке типов, риск ошибок. |

## Последствия
- Требуется поддерживать `schema.prisma`, запуск `prisma migrate deploy` при деплое.
- Необходимо добавить адаптеры Prisma для NestJS (поставщик `PrismaService`).
- Версионирование миграций обязательно, стратегия отката — `prisma migrate resolve` + SQL бэкапы.
