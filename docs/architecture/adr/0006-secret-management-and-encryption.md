# ADR 0006 — Управление секретами и шифрование данных

- **Дата**: 2025-11-07
- **Статус**: Утверждено
- **Контекст**: Система обрабатывает ключи к внешним провайдерам (SerpApi, LLM). Необходимо безопасно хранить секреты в Docker Compose среде и шифровать их в PostgreSQL.

## Решение
- Хранить конфиденциальные значения в Docker secrets / внешнем secret store (Vault, Doppler). Переменные окружения в `.env` содержат только ссылки/идентификаторы.
- В БД шифровать секреты с помощью `pgcrypto` (`pgp_sym_encrypt`) с master key, предоставленным через переменную окружения контейнера.
- Использовать `packages/shared/crypto` для централизованной работы с шифрованием/дешифрованием и аудита доступа.

## Обоснование
- Docker secrets/secret store отделяет секреты от образов/репозитория.
- pgcrypto позволяет прозрачно шифровать на уровне БД, исключая экспозицию в дампах без ключа.
- Единая библиотека шифрования упрощает аудит и ротацию ключей.

## Рассмотренные альтернативы
| Вариант | Плюсы | Минусы |
|---------|-------|--------|
| KMS облачного провайдера | Централизованный аудит | Требует облачной инфраструктуры; выход за пределы Compose. |
| Приложенческое шифрование (Node.js crypto) + plain storage | Простота | Риск ошибиться в реализации, нужно хранить IV/nonce и ключи вручную. |
| Unencrypted хранение | Низкая сложность | Не соответствует требованиям безопасности. |

## Последствия
- Необходимо управлять жизненным циклом master key (сторона DevOps).
- При бэкапах PostgreSQL следует хранить ключ отдельно, иначе расшифровка невозможна.
- Все операции с секретами логируются через Audit trail (`audit_events`).
