# ADR 0004 — Логирование, трассировка и метрики

- **Дата**: 2025-11-07
- **Статус**: Утверждено
- **Контекст**: Требуется обеспечить структурные логи, метрики и трассировку для API и worker. Нужна кореляция запросов и задач, соблюдение NFR по наблюдаемости.

## Решение
- Логирование через **Pino** (JSON) с обязательными полями `timestamp`, `level`, `service`, `requestId`, `jobId`, `actorId`.
- Метрики через **Prometheus** (`prom-client`, экспозиция `/metrics`).
- Трассировка через **OpenTelemetry** (OTLP), экспортер в Tempo/Jaeger.

## Обоснование
- Pino минимально влияет на производительность, хорошо интегрируется с NestJS и BullMQ.
- Prometheus — де-факто стандарт, совместим с Grafana, Alertmanager.
- OpenTelemetry обеспечивает единый стандарт трассировки для HTTP, Redis, PostgreSQL, Puppeteer.
- Легко развернуть в Compose (экспортеры как sidecar).

## Рассмотренные альтернативы
| Вариант | Плюсы | Минусы |
|---------|-------|--------|
| Winston | Гибкие транспорты | Медленнее, больше конфигурации.
| NewRelic/Datadog | SaaS, меньше поддержки | Стоимость, вендор-лок, зависимость от облака.
| Elastic APM | Всё-в-одном | Тяжелее, требует доп. ресурсов.

## Последствия
- Необходимо внедрить middleware для присвоения `requestId` и `jobId` (через AsyncLocalStorage).
- Требуется конфигурация экспортеров в `infra/compose` (Prometheus, Loki/Tempo).
- Алёрты хранятся как код (`infra/observability/alerts.yaml`, TBD).
