# ADR 0003 — Очереди и обработка фоновых задач

- **Дата**: 2025-11-07
- **Статус**: Утверждено
- **Контекст**: Необходимо отделить тяжёлые операции (SerpApi, Puppeteer, LLM) от API. Нужны задержки, ретраи, контроль конкурентности, мониторинг. Целевая инфраструктура — один узел Docker Compose.

## Решение
Использовать **BullMQ** (Redis 7+) в сочетании с отдельным сервисом `worker`.

## Обоснование
- BullMQ основан на Redis Streams, поддерживает планирование, задержки, ретраи, job concurrency out-of-the-box.
- Хорошая интеграция с Node.js/TypeScript, есть инструменты мониторинга (bull-board, custom metrics).
- Redis уже используется как кеш и брокер; минимум дополнительных компонентов.
- Поддерживает распределённые блокировки (job deduplication) и rate limiting по очередям.

## Рассмотренные альтернативы
| Вариант | Плюсы | Минусы |
|---------|-------|--------|
| RabbitMQ + custom worker | Продвинутые возможности маршрутизации | Требует отдельного брокера и поддержки; усложняет Compose.
| Temporal.io | Надёжные оркестрации | Высокий порог внедрения, требует дополнительного стека (Temporal server + Cassandra/PostgreSQL).
| AWS SQS/SNS | Масштабируемость | Не подходит для on-premise Compose, повышает задержки.

## Последствия
- Требуется управление Redis (monitoring, persistence, `maxmemory-policy` = `noeviction`).
- Нужен слой абстракции над BullMQ для трекинга прогресса и audit trail.
- Воркеры должны быть идемпотентны и аккуратно управлять Puppeteer пулами.
